apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: applications.platform.internal
spec:
  group: platform.internal
  names:
    kind: Application
    listKind: ApplicationList
    plural: applications
    singular: application
    shortNames:
      - app
      - apps
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Framework
          type: string
          jsonPath: .spec.framework
        - name: Environment
          type: string
          jsonPath: .spec.environment
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: URL
          type: string
          jsonPath: .status.url
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - repository
                - framework
                - environment
              properties:
                repository:
                  type: string
                  description: Git repository URL
                branch:
                  type: string
                  default: main
                  description: Git branch
                framework:
                  type: string
                  enum:
                    - nextjs
                    - rails
                    - static
                    - docker
                  description: Application framework
                environment:
                  type: string
                  enum:
                    - staging
                    - uat
                    - production
                    - preview
                  description: Deployment environment
                imageRef:
                  type: string
                  description: Container image reference (set by CI)
                envVars:
                  type: array
                  description: Additional environment variables
                  items:
                    type: object
                    required:
                      - name
                    properties:
                      name:
                        type: string
                      value:
                        type: string
                      secretKeyRef:
                        type: object
                        properties:
                          name:
                            type: string
                          key:
                            type: string
                database:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    schemaName:
                      type: string
                    migrations:
                      type: object
                      properties:
                        path:
                          type: string
                        engine:
                          type: string
                          enum:
                            - prisma
                            - knex
                            - raw
                storage:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    buckets:
                      type: array
                      items:
                        type: object
                        required:
                          - name
                        properties:
                          name:
                            type: string
                          public:
                            type: boolean
                            default: false
                          maxFileSize:
                            type: string
                auth:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    providers:
                      type: array
                      items:
                        type: string
                        enum:
                          - google
                          - github
                          - saml
                          - oidc
                redis:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                search:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                scaling:
                  type: object
                  properties:
                    min:
                      type: integer
                      default: 2
                    max:
                      type: integer
                      default: 20
                    targetCPU:
                      type: integer
                      default: 70
                domain:
                  type: string
                  description: Custom domain
                cors:
                  type: object
                  properties:
                    origins:
                      type: array
                      items:
                        type: string
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Pending
                    - Provisioning
                    - Running
                    - Failed
                    - Terminating
                url:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        enum:
                          - DatabaseReady
                          - StorageReady
                          - AuthReady
                          - DeploymentReady
                          - IngressReady
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
