# Generated by `plattr init` â€” DO NOT EDIT
# To update, run `plattr upgrade`
name: Plattr Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  APP_NAME: __APP_NAME__
  PLATTR_MODULE: github.com/__YOUR_ORG__/plattr//packages/dagger@v1.0.0
  AWS_REGION: ca-central-1
  ECR_REGISTRY: __ECR_REGISTRY__

jobs:
  # Build once, promote everywhere
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Test
        uses: dagger/dagger-for-github@v6
        with:
          verb: call
          module: ${{ env.PLATTR_MODULE }}
          args: test --source=.

      - name: Build and push
        id: build
        uses: dagger/dagger-for-github@v6
        with:
          verb: call
          module: ${{ env.PLATTR_MODULE }}
          args: >-
            build-and-push
            --source=.
            --app-name=${{ env.APP_NAME }}
            --environment=ci
            --registry-url=${{ env.ECR_REGISTRY }}

  # Preview (PRs only)
  preview:
    if: github.event_name == 'pull_request'
    needs: build
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name plattr-nonprod --region ${{ env.AWS_REGION }}

      - name: Deploy preview
        run: |
          kubectl apply -f - <<EOF
          apiVersion: platform.internal/v1alpha1
          kind: PreviewEnvironment
          metadata:
            name: ${{ env.APP_NAME }}-pr-${{ github.event.pull_request.number }}
            namespace: plattr-system
          spec:
            applicationRef: ${{ env.APP_NAME }}
            pullRequest: ${{ github.event.pull_request.number }}
            branch: ${{ github.head_ref }}
            imageRef: ${{ env.ECR_REGISTRY }}/plattr-apps:${{ needs.build.outputs.image-tag }}
            ttl: 72h
          EOF

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `**Plattr Preview** ðŸš€\nLive at: https://pr-${{ github.event.pull_request.number }}.${{ env.APP_NAME }}.preview.company.dev`
            })

  # Staging (auto on merge to main)
  staging:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name plattr-nonprod --region ${{ env.AWS_REGION }}

      - name: Deploy to staging
        run: |
          kubectl apply -f - <<EOF
          apiVersion: platform.internal/v1alpha1
          kind: Application
          metadata:
            name: ${{ env.APP_NAME }}
            namespace: staging
          spec:
            repository: ${{ github.repository }}
            branch: main
            framework: __FRAMEWORK__
            environment: staging
            imageRef: ${{ env.ECR_REGISTRY }}/plattr-apps:${{ needs.build.outputs.image-tag }}
          EOF

  # UAT (manual approval)
  uat:
    needs: staging
    runs-on: ubuntu-latest
    environment:
      name: uat
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name plattr-nonprod --region ${{ env.AWS_REGION }}

      - name: Deploy to UAT
        run: |
          kubectl apply -f - <<EOF
          apiVersion: platform.internal/v1alpha1
          kind: Application
          metadata:
            name: ${{ env.APP_NAME }}
            namespace: uat
          spec:
            repository: ${{ github.repository }}
            branch: main
            framework: __FRAMEWORK__
            environment: uat
            imageRef: ${{ env.ECR_REGISTRY }}/plattr-apps:${{ needs.build.outputs.image-tag }}
          EOF

  # Production (manual approval, separate AWS account)
  production:
    needs: uat
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Configure AWS credentials (prod account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig (prod cluster)
        run: aws eks update-kubeconfig --name plattr-prod --region ${{ env.AWS_REGION }}

      - name: Deploy to production
        run: |
          kubectl apply -f - <<EOF
          apiVersion: platform.internal/v1alpha1
          kind: Application
          metadata:
            name: ${{ env.APP_NAME }}
            namespace: production
          spec:
            repository: ${{ github.repository }}
            branch: main
            framework: __FRAMEWORK__
            environment: production
            imageRef: ${{ env.ECR_REGISTRY }}/plattr-apps:${{ needs.build.outputs.image-tag }}
          EOF
